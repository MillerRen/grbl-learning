<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>G代码解析器 | GRBL 源码解析与移植</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="GRBL源码精度与解析，代码行级中文注释并提供丰富详尽的案例展示。">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.26305e5e.js" as="script"><link rel="preload" href="/assets/js/2.495ffcb8.js" as="script"><link rel="preload" href="/assets/js/1.65b8fb93.js" as="script"><link rel="preload" href="/assets/js/32.4c81109f.js" as="script"><link rel="prefetch" href="/assets/js/10.e5f0c1f9.js"><link rel="prefetch" href="/assets/js/11.d74d0da6.js"><link rel="prefetch" href="/assets/js/12.b8e4f81b.js"><link rel="prefetch" href="/assets/js/13.814df329.js"><link rel="prefetch" href="/assets/js/14.5246fb06.js"><link rel="prefetch" href="/assets/js/15.46074ed7.js"><link rel="prefetch" href="/assets/js/16.6a188078.js"><link rel="prefetch" href="/assets/js/17.2e0240b0.js"><link rel="prefetch" href="/assets/js/18.f10ed367.js"><link rel="prefetch" href="/assets/js/19.e1261ca5.js"><link rel="prefetch" href="/assets/js/20.bdd28f89.js"><link rel="prefetch" href="/assets/js/21.e77d95ae.js"><link rel="prefetch" href="/assets/js/22.0ba45860.js"><link rel="prefetch" href="/assets/js/23.fb7a741a.js"><link rel="prefetch" href="/assets/js/24.533671ad.js"><link rel="prefetch" href="/assets/js/25.8a64622f.js"><link rel="prefetch" href="/assets/js/26.ddbc1448.js"><link rel="prefetch" href="/assets/js/27.d466dc4d.js"><link rel="prefetch" href="/assets/js/28.6f391f4d.js"><link rel="prefetch" href="/assets/js/29.0e9ce670.js"><link rel="prefetch" href="/assets/js/3.dfa179b7.js"><link rel="prefetch" href="/assets/js/30.08927b57.js"><link rel="prefetch" href="/assets/js/31.3f38012d.js"><link rel="prefetch" href="/assets/js/33.dda45bfd.js"><link rel="prefetch" href="/assets/js/34.cfe94d64.js"><link rel="prefetch" href="/assets/js/35.ca9820e8.js"><link rel="prefetch" href="/assets/js/36.d252e61f.js"><link rel="prefetch" href="/assets/js/37.16a81b2e.js"><link rel="prefetch" href="/assets/js/38.719b0b94.js"><link rel="prefetch" href="/assets/js/39.cbe0265e.js"><link rel="prefetch" href="/assets/js/4.b28b260a.js"><link rel="prefetch" href="/assets/js/40.8d7b9a6a.js"><link rel="prefetch" href="/assets/js/41.dea09da6.js"><link rel="prefetch" href="/assets/js/42.33100528.js"><link rel="prefetch" href="/assets/js/43.b0efc93d.js"><link rel="prefetch" href="/assets/js/44.f76a5346.js"><link rel="prefetch" href="/assets/js/45.ae57874d.js"><link rel="prefetch" href="/assets/js/46.28214ccd.js"><link rel="prefetch" href="/assets/js/47.74b505a6.js"><link rel="prefetch" href="/assets/js/48.39ac7905.js"><link rel="prefetch" href="/assets/js/49.ea4f73c2.js"><link rel="prefetch" href="/assets/js/5.5394f6ea.js"><link rel="prefetch" href="/assets/js/50.be6835bc.js"><link rel="prefetch" href="/assets/js/51.1fe10630.js"><link rel="prefetch" href="/assets/js/52.d950408b.js"><link rel="prefetch" href="/assets/js/53.e011ace1.js"><link rel="prefetch" href="/assets/js/54.d443a239.js"><link rel="prefetch" href="/assets/js/55.f63cf3c4.js"><link rel="prefetch" href="/assets/js/56.df4b04d2.js"><link rel="prefetch" href="/assets/js/57.1adfe7c9.js"><link rel="prefetch" href="/assets/js/58.768912d0.js"><link rel="prefetch" href="/assets/js/59.0f47b7e1.js"><link rel="prefetch" href="/assets/js/6.5efdfc70.js"><link rel="prefetch" href="/assets/js/60.7e0e175a.js"><link rel="prefetch" href="/assets/js/61.911ee325.js"><link rel="prefetch" href="/assets/js/62.80828bb6.js"><link rel="prefetch" href="/assets/js/63.b641e1f7.js"><link rel="prefetch" href="/assets/js/64.3355053d.js"><link rel="prefetch" href="/assets/js/7.91537c65.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.6fed1ae2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="GRBL 源码解析与移植" class="logo"> <span class="site-name can-hide">GRBL 源码解析与移植</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/preface.html" class="sidebar-link">前言</a></li><li><a href="/prepare.html" class="sidebar-link">准备工作</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/analysis/" class="sidebar-heading clickable router-link-active open"><span>GRBL源码解析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/analysis/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/analysis/architecture.html" class="sidebar-link">架构</a></li><li><a href="/analysis/main.html" class="sidebar-link">入口</a></li><li><a href="/analysis/serial.html" class="sidebar-link">协议-串口</a></li><li><a href="/analysis/protocol.html" class="sidebar-link">协议-主循环</a></li><li><a href="/analysis/gcode.html" aria-current="page" class="active sidebar-link">协议-G代码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/analysis/gcode.html#g代码" class="sidebar-link">G代码</a></li><li class="sidebar-sub-header"><a href="/analysis/gcode.html#g代码的模态" class="sidebar-link">G代码的模态</a></li><li class="sidebar-sub-header"><a href="/analysis/gcode.html#解释器-interpretor" class="sidebar-link">解释器（interpretor）</a></li><li class="sidebar-sub-header"><a href="/analysis/gcode.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/analysis/motion.html" class="sidebar-link">运动-控制</a></li><li><a href="/analysis/planner.html" class="sidebar-link">运动-规划</a></li><li><a href="/analysis/acceleration.html" class="sidebar-link">运动-加减速</a></li><li><a href="/analysis/bresenham.html" class="sidebar-link">运动-差值</a></li><li><a href="/analysis/stepper.html" class="sidebar-link">运动-执行</a></li><li><a href="/analysis/spindle.html" class="sidebar-link">附件-主轴</a></li><li><a href="/analysis/coolant.html" class="sidebar-link">附件-冷却</a></li><li><a href="/analysis/endstop.html" class="sidebar-link">运动-限制</a></li><li><a href="/analysis/emergency.html" class="sidebar-link">运动-安全</a></li><li><a href="/analysis/homing.html" class="sidebar-link">运动-归位</a></li><li><a href="/analysis/probe.html" class="sidebar-link">运动-对刀</a></li><li><a href="/analysis/report.html" class="sidebar-link">接口-报告</a></li><li><a href="/analysis/interface.html" class="sidebar-link">接口-上位机</a></li><li><a href="/analysis/settings.html" class="sidebar-link">参数-设置</a></li><li><a href="/analysis/eeprom.html" class="sidebar-link">参数-保存</a></li><li><a href="/analysis/runtime.html" class="sidebar-link">系统-运行时</a></li><li><a href="/analysis/state.html" class="sidebar-link">系统-状态机</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/porting/" class="sidebar-heading clickable"><span>GRBL移植</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/extensions/" class="sidebar-heading clickable"><span>GRBL扩展</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/appendix/" class="sidebar-link">附录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="g代码解析器"><a href="#g代码解析器" class="header-anchor">#</a> G代码解析器</h1> <h2 id="g代码"><a href="#g代码" class="header-anchor">#</a> G代码</h2> <p>G代码（G-code）是一种用于控制数控(CNC) 机器的标准编程语言，特别是在计算机辅助制造中。它用于指导机器执行各种操作，如移动、钻孔、切割等。它有多个版本，grbl参考<a href="/docs/RS274NGC_3.pdf">RS274/NGC第3版</a>实现了一个G代码解释器。</p> <h2 id="g代码的模态"><a href="#g代码的模态" class="header-anchor">#</a> G代码的模态</h2> <p>G-code 模态（Modal）是指G-code 命令的“状态”或“模式”。在G-code 中，某些命令会保持激活状态，直到被其他命令显式地更改或取消，这些保持激活状态的命令就被称为模态命令。简单来说，模态命令就像是设置了一个开关，一旦打开，除非你关闭它，否则它会一直保持这个状态，影响后续的G-code 执行。</p> <h3 id="模态命令"><a href="#模态命令" class="header-anchor">#</a> 模态命令：</h3> <p>激活后会一直保持状态，直到被其他模态命令覆盖或取消。例如，G01 (直线插补) 激活后，除非使用G00 (快速移动) 或其他移动指令来取消，否则后续的移动指令都会被认为是直线插补。</p> <h3 id="非模态命令"><a href="#非模态命令" class="header-anchor">#</a> 非模态命令：</h3> <p>每次执行都会生效，且只对紧随其后的运动有效。例如，F (进给率) 它只影响下一个移动命令，而不是所有后续移动。</p> <h3 id="模态组"><a href="#模态组" class="header-anchor">#</a> 模态组：</h3> <p>G-code 命令被分成了几个模态组，每个组内的命令是互斥的，即同一时刻只能有一个组内的命令处于激活状态。常见的模态组包括：</p> <ul><li>组0={G92.2，G92.3}（非模态：取消并重新启用G92偏移）</li> <li>第1组={G81-G89}（运动模式：罐装循环）</li> <li>组4={M1}（可选停止，忽略）</li> <li>第6组={M6}（换刀）</li> <li>组7={G41，G42}刀具半径补偿（支持G40）</li> <li>组8={G43}刀具长度偏移（支持G43.1/G49）</li> <li>组8={M7*}启用喷雾冷却液（*编译选项）</li> <li>组9={M48、M49、M56*}启用/禁用覆盖开关（*编译选项）</li> <li>组10={G98，G99}返回模式屏蔽循环</li> <li>组13={G61.1，G64}路径控制模式（支持G61）</li></ul> <p>grbl不支持的：</p> <ul><li>封闭圆</li> <li>刀具半径补偿</li> <li>A,B,C-轴</li> <li>表达式的求值</li> <li>变量</li> <li>覆盖控制 (TBD)</li> <li>换刀</li> <li>开关</li></ul> <p>这些模态组都在grbl的<code>gcode.h</code>中定义，代码如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// gcode.h</span>
<span class="token comment">// 定义模态组内部编号，用于检查多个命令冲突并跟踪</span>
<span class="token comment">// 在块中调用的命令类型。模态组是一组g代码命令，它们是</span>
<span class="token comment">// 相互排斥，或不能存在于同一行上，因为它们各自切换状态或执行</span>
<span class="token comment">// 独特的运动。这些定义见NIST RS274-NGC v3 g代码标准，可在线获取，</span>
<span class="token comment">// 并且与制造商（Haas、Fanuc、Mazak等）提供的其他g代码解释器类似/相同。</span>
<span class="token comment">// 注意：模态组定义值必须是连续的，并且从零开始。</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G0</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// [G4、G10、G28、G28.1、G30、G30.1、G53、G92、G92.1]非模态</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G1</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// [G0，G1，G2，G3，G38,2，G38,3，G38,4，G38,5，G80]运动</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G2</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// [G17、G18、G19]平面选择</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G3</span> <span class="token expression"><span class="token number">3</span> </span><span class="token comment">// [G90，G91]距离模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G4</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">// [G91.1]电弧IJK距离模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G5</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">// [G93，G94]进给速度模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G6</span> <span class="token expression"><span class="token number">6</span> </span><span class="token comment">// [G20，G21]单位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G7</span> <span class="token expression"><span class="token number">7</span> </span><span class="token comment">// [G40]刀具半径补偿模式。不支持G41/42。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G8</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">// [G43.1，G49]刀具长度偏移</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G12</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">// [G54、G55、G56、G57、G58、G59]坐标系选择</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_G13</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// [G61]控制模式</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_M4</span> <span class="token expression"><span class="token number">11</span> </span><span class="token comment">// [M0，M1，M2，M30]停止</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_M7</span> <span class="token expression"><span class="token number">12</span> </span><span class="token comment">// [M3、M4、M5]主轴调整</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_M8</span> <span class="token expression"><span class="token number">13</span> </span><span class="token comment">// [M7，M8，M9]冷却液控制</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODAL_GROUP_M9</span> <span class="token expression"><span class="token number">14</span> </span><span class="token comment">// [M56]覆盖控制</span></span>

 <span class="token comment">// 定义执行类型内模态组（运动、停止、非模态）的命令动作。</span>
 <span class="token comment">// 解析器在内部使用，以了解要执行的命令。</span>
 <span class="token comment">// 注意：一些宏值被指定为特定值，以使g代码状态报告和解析编译更小。由于328p上的闪存完全耗尽，因此有必要。</span>
 <span class="token comment">// 虽然不理想，但只要小心使用状态为“不改变”的值，并检查两个报告即可。c和gcode。如果您需要更改它们，请查看它们是如何使用的。</span>

 <span class="token comment">// 模态组G0：非模态动作</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_NO_ACTION</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// （默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_DWELL</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">// G4（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_SET_COORDINATE_DATA</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// G10（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_GO_HOME_0</span> <span class="token expression"><span class="token number">28</span> </span><span class="token comment">// G28（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_SET_HOME_0</span> <span class="token expression"><span class="token number">38</span> </span><span class="token comment">// G28.1（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_GO_HOME_1</span> <span class="token expression"><span class="token number">30</span> </span><span class="token comment">// G30（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_SET_HOME_1</span> <span class="token expression"><span class="token number">40</span> </span><span class="token comment">// G30.1（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_ABSOLUTE_OVERRIDE</span> <span class="token expression"><span class="token number">53</span> </span><span class="token comment">// G53（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_SET_COORDINATE_OFFSET</span> <span class="token expression"><span class="token number">92</span> </span><span class="token comment">// G92（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MODAL_RESET_COORDINATE_OFFSET</span> <span class="token expression"><span class="token number">102</span> </span><span class="token comment">// G92。1（不要改变值）</span></span>

 <span class="token comment">// 模态组G1：运动模态</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_SEEK</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G0（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_LINEAR</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// G1（不改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_CW_ARC</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// G2（不改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_CCW_ARC</span> <span class="token expression"><span class="token number">3</span> </span><span class="token comment">// G3（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_PROBE_TOWARD</span> <span class="token expression"><span class="token number">140</span> </span><span class="token comment">// G38.2（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_PROBE_TOWARD_NO_ERROR</span> <span class="token expression"><span class="token number">141</span> </span><span class="token comment">// G38。3（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_PROBE_AWAY</span> <span class="token expression"><span class="token number">142</span> </span><span class="token comment">// G38.4（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_PROBE_AWAY_NO_ERROR</span> <span class="token expression"><span class="token number">143</span> </span><span class="token comment">// G38。5（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOTION_MODE_NONE</span> <span class="token expression"><span class="token number">80</span> </span><span class="token comment">// G80（不要改变值）</span></span>

 <span class="token comment">// 模态组G2：平面选择</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLANE_SELECT_XY</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G17（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLANE_SELECT_ZX</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// G18（不要改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLANE_SELECT_YZ</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// G19（不要改变值）</span></span>

 <span class="token comment">// 模式组G3：距离模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISTANCE_MODE_ABSOLUTE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G90（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISTANCE_MODE_INCREMENTAL</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// G91（不要改变值）</span></span>

 <span class="token comment">// 模式组G4：Arc IJK距离模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISTANCE_ARC_MODE_INCREMENTAL</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G91.1（默认值：必须为零）</span></span>

 <span class="token comment">// 模态组M4：程序流</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROGRAM_FLOW_RUNNING</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// （默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROGRAM_FLOW_PAUSED</span> <span class="token expression"><span class="token number">3</span>  </span><span class="token comment">//  M0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROGRAM_FLOW_OPTIONAL_STOP</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// M1注意：不支持，但有效且被忽略。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROGRAM_FLOW_COMPLETED_M2</span>  <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// M2（不改变值）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROGRAM_FLOW_COMPLETED_M30</span> <span class="token expression"><span class="token number">30</span> </span><span class="token comment">// M30（不改变值）</span></span>

 <span class="token comment">// 模式组G5：进给速度模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FEED_RATE_MODE_UNITS_PER_MIN</span>  <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G94（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FEED_RATE_MODE_INVERSE_TIME</span>   <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// G93（不要改变值）</span></span>

 <span class="token comment">// 模态组G6：单元模态</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UNITS_MODE_MM</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G21（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UNITS_MODE_INCHES</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// G20（不改变值）</span></span>

 <span class="token comment">// 模式组G7：刀具半径补偿模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CUTTER_COMP_DISABLE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G40（默认值：必须为零）</span></span>

 <span class="token comment">// 模式组G13：控制模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONTROL_MODE_EXACT_PATH</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G61（默认值：必须为零）</span></span>

 <span class="token comment">// 模态组M7：主轴控制</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPINDLE_DISABLE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// M5（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPINDLE_ENABLE_CW</span>   <span class="token expression">PL_COND_FLAG_SPINDLE_CW </span><span class="token comment">// M3（注：使用计划器条件位标志）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPINDLE_ENABLE_CCW</span>  <span class="token expression">PL_COND_FLAG_SPINDLE_CCW </span><span class="token comment">// M4（注意：使用计划器条件位标志）</span></span>

 <span class="token comment">// 模式组M8：冷却液控制</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COOLANT_DISABLE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// M9（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COOLANT_FLOOD_ENABLE</span>  <span class="token expression">PL_COND_FLAG_COOLANT_FLOOD </span><span class="token comment">// M8（注意：使用计划器条件位标志）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COOLANT_MIST_ENABLE</span>   <span class="token expression">PL_COND_FLAG_COOLANT_MIST </span><span class="token comment">// M7（注：使用计划器条件位标志）</span></span>

 <span class="token comment">// 模式组G8：刀具长度偏移</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TOOL_LENGTH_OFFSET_CANCEL</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// G49（默认值：必须为零）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TOOL_LENGTH_OFFSET_ENABLE_DYNAMIC</span> <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">//  G43.1</span></span>

 <span class="token comment">// 模态组M9：超越控制</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEACTIVATE_PARKING_UPON_INIT</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OVERRIDE_DISABLED</span>  <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// （默认值：必须为零）</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OVERRIDE_PARKING_MOTION</span> <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">//  M56</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OVERRIDE_PARKING_MOTION</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// M56（默认值：必须为零）</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OVERRIDE_DISABLED</span>  <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// 禁止停车。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

 <span class="token comment">// 模态组G12：活动工作坐标系</span>
 <span class="token comment">// 不适用：存储要更改为的坐标系值（54-59）。</span>
</code></pre></div><h2 id="解释器-interpretor"><a href="#解释器-interpretor" class="header-anchor">#</a> 解释器（interpretor）</h2> <p>解析器这部分都代码比较长，也比较复杂，初看很难理解，但我们可以把它当作一门脚本语言（实际上就是）来理解，就清楚多了，因为脚本语言有标准化的解释方法及步骤。
实现一个解析器的主要步骤包括：<strong>词法分析、语法分析和语义分析</strong>。词法分析将源代码分解成词法单元（tokens），语法分析验证这些词法单元是否符合语法规则，语义分析则检查代码的含义和正确性。</p> <p>具体步骤如下：</p> <ol><li><strong>词法分析(Lexical Analysis/Scanning):</strong></li></ol> <p>导入块行中的所有g代码字。g代码字是一个字母后跟一个数字，可以是“G”/“M”命令，也可以设置/分配命令值。
而且对任何重复的命令字模式组冲突执行初始错误检查，代码简化为：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// gcode.c</span>

<span class="token comment">// 执行一行以0结尾的G代码。</span>
<span class="token comment">// 假定该行仅包含大写字符和有符号浮点值（无空格）。</span>
<span class="token comment">// 注释和块删除字符已被删除。</span>
<span class="token comment">// 在该函数中，所有单位和位置分别以（毫米，毫米/分钟）和绝对机器坐标转换并导出为grbl的内部函数。</span>
<span class="token class-name">uint8_t</span> <span class="token function">gc_execute_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>line<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> char_counter<span class="token punctuation">;</span>
    <span class="token keyword">char</span> letter<span class="token punctuation">;</span>
    <span class="token keyword">float</span> value<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> int_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> mantissa <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span>char_counter<span class="token punctuation">]</span> <span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        letter <span class="token operator">=</span> line<span class="token punctuation">[</span>char_counter<span class="token punctuation">]</span><span class="token punctuation">;</span>
        char_counter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">read_float</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token operator">&amp;</span>char_counter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        int_value <span class="token operator">=</span> <span class="token function">trunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mantissa <span class="token operator">=</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token punctuation">(</span>value <span class="token operator">-</span> int_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&quot;G&quot;</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;M&quot;</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// 非命令字，检查剩余其他合法的G代码字（F,I,J,K,L,N,P,R,S,T,X,Y,Z），并为其赋值。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过一个while循环，不断地从字符串中分离出词（word），例如<code>M3</code>、<code>G1</code> 、<code>X11.111</code> 等。然后把它们分为<code>G</code>命令、<code>M</code>命令和其他合法G代码。此时，g代码块已被解析，可以释放行缓冲区。</p> <ol start="2"><li><strong>语法分析(Syntax Analysis/Parsing):</strong></li></ol> <p>grbl不支持变量和表达式求值，因此这部分并不复杂。
根据G代码的定义，将词法单元序列构建成对应的语法结构<code>gc_block</code>，如果不符合语法规则则报告语法错误。如<code>M</code>命令后没有小数部分。</p> <ul><li><code>gc_block.non_modal_command</code>非模态命令。</li> <li><code>gc_block.modal</code>模态命令的一些属性运动模式、进给率、单位选择、距离模式、平面选择、坐标系选择主轴、冷却、覆盖。</li> <li><code>gc_block.values</code>非命令的字参数值：进给、圆弧偏移、暂停、弧半径、主轴、转速、xyz轴值。</li></ul> <ol start="3"><li><strong>语义分析(Semantic Analysis):</strong></li></ol> <p>错误检查此块中传递的所有命令和值。这一步确保了所有命令执行有效，并尽可能遵循NIST标准。
如果发现错误，将转储此块中的所有命令和值，并且不会更新激活的系统g代码模式。
如果模块正常，则激活的系统g代码模式将被激活根据此块的命令进行更新，并发出执行信号。</p> <p>此外，我们还必须根据被解析对象设置的模式对传递的所有值进行预转换块 。
有许多错误检查需要目标信息，只有在我们结合错误检查转换这些值时才能准确计算这些信息。</p> <ol start="0"><li>非特定/常见错误检查和其他设置</li> <li>注释，不支持MSG。由协议执行的注释处理。</li> <li>设置进给速度模式，G1、G2/3激活，隐式或显式</li> <li>设定进给速度</li> <li>设置主轴转速</li> <li>选择工具，不支持</li> <li>更换工具，不适用</li> <li>主轴控制，不适用</li> <li>冷却液控制：不适用</li> <li>覆盖控制：不受支持，仅Grbl停靠运动覆盖控制除外。</li> <li>暂停：缺少P值。P为负</li> <li>设置活动平面：不适用</li> <li>刀具半径补偿：不支持G41/42。如果在G53激活时启用则报错。</li> <li>刀具长度补偿：不支持G43，但支持G43.1和G49支持。</li> <li>坐标系选择：不适用。如果刀具半径补偿激活则报错。</li> <li>设置路径控制模式：不适用。仅G61。G61.1和G64不受支持。</li> <li>设置距离模式：不适用。仅G91.1.G90.1不受支持。</li> <li>设置缩回模式：不支持。</li> <li>剩余非模态动作：选中“转到预定义位置”、“设置G10”或“设置轴偏移”。</li> <li>运动模式</li> <li>程序流程：无需进行错误检查。</li></ol> <p>经过上述步骤检查和预转换，已经排除了错误，运动所需信息已准备好，下一执行步骤降级为仅更新系统g代码模式并按顺序执行编程动作。</p> <ol start="4"><li><strong>代码执行(Code Execute) (可选):</strong></li></ol> <p>如果需要将源代码编译成其他语言或机器代码，则需要进行代码生成。grbl是解释性语言，这一步不会生成目标代码，而是直接执行。
执行步骤不需要任何转换计算，只需要执行所需的最少检查。
假设已完成所有错误检查，且不存在任何故障模式。我们只是需要更新状态并根据执行顺序执行块。
执行主要有以下几部分：</p> <ul><li><code>jog_execute()</code>：执行点动动作</li> <li><code>spindle_sync</code>： 执行更新主轴转速</li> <li><code>coolant_sync</code>： 执行冷却控制</li> <li><code>mc_dwell</code>：     执行暂停</li> <li><code>mc_line</code>：      执行直线运动</li> <li><code>mc_arc</code>：       执行圆弧运动</li> <li><code>mc_probe_cycle</code>：执行探针运动</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>grbl通过<code>gc_execute_line()</code> 从行缓冲区<code>line[]</code>取出G代码并进行解析，解析完成后调用其他模块执行对应的动作，例如主轴和轴运动（mc_xxx）。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/analysis/protocol.html" class="prev">
        协议-主循环
      </a></span> <span class="next"><a href="/analysis/motion.html">
        运动-控制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26305e5e.js" defer></script><script src="/assets/js/2.495ffcb8.js" defer></script><script src="/assets/js/1.65b8fb93.js" defer></script><script src="/assets/js/32.4c81109f.js" defer></script>
  </body>
</html>
