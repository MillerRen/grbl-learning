<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构 | GRBL 源码解析与移植</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="GRBL源码精度与解析，代码行级中文注释并提供丰富详尽的案例展示。">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.d7d3e404.js" as="script"><link rel="preload" href="/assets/js/2.2179b996.js" as="script"><link rel="preload" href="/assets/js/8.66aa924d.js" as="script"><link rel="prefetch" href="/assets/js/10.43721e34.js"><link rel="prefetch" href="/assets/js/11.94485d27.js"><link rel="prefetch" href="/assets/js/12.62821b06.js"><link rel="prefetch" href="/assets/js/13.8de29ef2.js"><link rel="prefetch" href="/assets/js/14.de9f355a.js"><link rel="prefetch" href="/assets/js/15.10c69e8b.js"><link rel="prefetch" href="/assets/js/16.81e91af6.js"><link rel="prefetch" href="/assets/js/17.946d1ce0.js"><link rel="prefetch" href="/assets/js/18.e33a28bd.js"><link rel="prefetch" href="/assets/js/19.77386b6f.js"><link rel="prefetch" href="/assets/js/20.091e6fb2.js"><link rel="prefetch" href="/assets/js/21.06db4577.js"><link rel="prefetch" href="/assets/js/22.222069d8.js"><link rel="prefetch" href="/assets/js/23.70e115df.js"><link rel="prefetch" href="/assets/js/24.fc512beb.js"><link rel="prefetch" href="/assets/js/25.d60ff0f6.js"><link rel="prefetch" href="/assets/js/26.e56b5ba3.js"><link rel="prefetch" href="/assets/js/27.f03d4f84.js"><link rel="prefetch" href="/assets/js/28.efb12f8a.js"><link rel="prefetch" href="/assets/js/29.4cef9913.js"><link rel="prefetch" href="/assets/js/3.7769cc81.js"><link rel="prefetch" href="/assets/js/30.d669c7ff.js"><link rel="prefetch" href="/assets/js/31.d06babf5.js"><link rel="prefetch" href="/assets/js/32.166a6dc2.js"><link rel="prefetch" href="/assets/js/33.533dc180.js"><link rel="prefetch" href="/assets/js/34.1b934459.js"><link rel="prefetch" href="/assets/js/35.12a39adc.js"><link rel="prefetch" href="/assets/js/36.c3bd12bc.js"><link rel="prefetch" href="/assets/js/37.5d15a6fd.js"><link rel="prefetch" href="/assets/js/38.9cbd22d9.js"><link rel="prefetch" href="/assets/js/39.fdd5b48e.js"><link rel="prefetch" href="/assets/js/4.7e1f184d.js"><link rel="prefetch" href="/assets/js/40.8b1c15b8.js"><link rel="prefetch" href="/assets/js/41.7c9440bb.js"><link rel="prefetch" href="/assets/js/42.209b84b2.js"><link rel="prefetch" href="/assets/js/43.9eabc9ae.js"><link rel="prefetch" href="/assets/js/44.08fb7642.js"><link rel="prefetch" href="/assets/js/45.93f46a58.js"><link rel="prefetch" href="/assets/js/5.44e5e94b.js"><link rel="prefetch" href="/assets/js/6.c60b674b.js"><link rel="prefetch" href="/assets/js/7.7e458f75.js"><link rel="prefetch" href="/assets/js/9.79ed1b22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="GRBL 源码解析与移植" class="logo"> <span class="site-name can-hide">GRBL 源码解析与移植</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/preface.html" class="sidebar-link">前言</a></li><li><a href="/prepare.html" class="sidebar-link">准备工作</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/analysis/" class="sidebar-heading clickable router-link-active open"><span>GRBL源码解析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/analysis/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/analysis/architecture.html" aria-current="page" class="active sidebar-link">架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/analysis/architecture.html#架构图" class="sidebar-link">架构图</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#入口" class="sidebar-link">入口</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#串口通信" class="sidebar-link">串口通信</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#主循环" class="sidebar-link">主循环</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#运动规划模块" class="sidebar-link">运动规划模块</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#动作模块" class="sidebar-link">动作模块</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#输入控制模块" class="sidebar-link">输入控制模块</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#参数设置模块" class="sidebar-link">参数设置模块</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#引脚映射模块" class="sidebar-link">引脚映射模块</a></li><li class="sidebar-sub-header"><a href="/analysis/architecture.html#辅助模块" class="sidebar-link">辅助模块</a></li></ul></li><li><a href="/analysis/main.html" class="sidebar-link">入口</a></li><li><a href="/analysis/protocol.html" class="sidebar-link">协议-主循环</a></li><li><a href="/analysis/serial.html" class="sidebar-link">串口</a></li><li><a href="/analysis/system.html" class="sidebar-link">状态机</a></li><li><a href="/analysis/gcode.html" class="sidebar-link">G代码解析</a></li><li><a href="/analysis/motion.html" class="sidebar-link">运动控制</a></li><li><a href="/analysis/planner.html" class="sidebar-link">运动规划</a></li><li><a href="/analysis/acceleration.html" class="sidebar-link">加速度算法</a></li><li><a href="/analysis/bresenham.html" class="sidebar-link">bresenham插值算法</a></li><li><a href="/analysis/stepper.html" class="sidebar-link">运动执行-步进电机</a></li><li><a href="/analysis/spindle.html" class="sidebar-link">主轴</a></li><li><a href="/analysis/coolant.html" class="sidebar-link">冷却</a></li><li><a href="/analysis/endstop.html" class="sidebar-link">限位开关</a></li><li><a href="/analysis/homing.html" class="sidebar-link">归位</a></li><li><a href="/analysis/probe.html" class="sidebar-link">对刀</a></li><li><a href="/analysis/emergency.html" class="sidebar-link">安全-紧急事件</a></li><li><a href="/analysis/settings.html" class="sidebar-link">参数设置</a></li><li><a href="/analysis/interface.html" class="sidebar-link">上位机接口</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/porting/" class="sidebar-heading clickable"><span>GRBL移植</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/extensions/" class="sidebar-heading clickable"><span>GRBL扩展</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/appendix/" class="sidebar-link">附录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h1> <h2 id="架构图"><a href="#架构图" class="header-anchor">#</a> 架构图</h2> <p>Grbl的核心是带有梯形加减速过程的直线插补算法的实现，它包含一个G代码的解析器，一个全局状态机，还有一系列的守护进程,是一个典型的前台+后台架构。前台是各种中断处理，后台是一个无限循环，然后通过状态机关联前后台，中断中不会执行复杂的任务，它只根据当前条件改变状态，后台通过状态执行相应的任务，比如G代码解析，运动前瞻规划，运动插值等。通过调用链分析，得到下图：</p> <p><img src="/assets/img/grbl-architecture.1d906c3c.png" alt="grbl architecture"></p> <p>Grbl运行在 Arduino UNO 硬件上，但是它并没有使用Arduino框架，原因在于Arduino的芯片atmega328p资源有限，而且Arduino框架占用了某些资源（比如定时器）。因此grbl所有的库都是自己封装的，通过操作寄存器实现的。通过grbl源码，我整理出了以下模块的作用：</p> <h2 id="入口"><a href="#入口" class="header-anchor">#</a> 入口</h2> <div class="language- extra-class"><pre><code>main.c 初始化外设，开启主循环
</code></pre></div><h2 id="串口通信"><a href="#串口通信" class="header-anchor">#</a> 串口通信</h2> <div class="language- extra-class"><pre><code>serial.c：低阶串口通信并为异步控制检出运行时的实时命令。

report.c：通知状态映射和消息组装

print.c：打印不同格式字符串的函数（用在串口）
</code></pre></div><h2 id="主循环"><a href="#主循环" class="header-anchor">#</a> 主循环</h2> <div class="language- extra-class"><pre><code>protocol.c: 从串口接受命令行并把他们传递到“gcode”执行。提供每个命令的状态响应。还管理串口中断的运行时命令集。

gcode.c：从“protocol”接收g代码，按照解析器的当前状态解析它并且通过“xxx_control”模块发出命令
</code></pre></div><h2 id="运动规划模块"><a href="#运动规划模块" class="header-anchor">#</a> 运动规划模块</h2> <div class="language- extra-class"><pre><code>motion_control.c: 从“gcode”接收移动命令并且传递他们到规划器。这个模块为规划器模块或步进电机模块提供公共接口。

planner.c: 从“motion_control”接收线性移动命令并且把他们添加到准备移动的计划中。它维护持被添加的移动续优化加速度路径。
</code></pre></div><h2 id="动作模块"><a href="#动作模块" class="header-anchor">#</a> 动作模块</h2> <div class="language- extra-class"><pre><code>stepper.c：按计划用步进电机按步执行移动

spindle.c: 控制主轴的命令

coolant_control.c：控制主轴冷却的命令
</code></pre></div><h2 id="输入控制模块"><a href="#输入控制模块" class="header-anchor">#</a> 输入控制模块</h2> <div class="language- extra-class"><pre><code>limits.c：配置限位开关，用来告诉机器源点位置，阻止超出行程范围

probe.c：对刀，告知Z轴0点位置

jog.c：手动控制机器移动

system.c：解析并执行系统命令（$开头），外部控制按钮响应
</code></pre></div><h2 id="参数设置模块"><a href="#参数设置模块" class="header-anchor">#</a> 参数设置模块</h2> <div class="language- extra-class"><pre><code>settings.c：在eeroom中维护运行时配置项并且让它对所有模块可用

config.h：编译时的用户配置

eeprom.c：一个Atmel的库，提供方法读或写eerom，添加了一点东西可以在读写二进制流的时候检查配置项的校验和。
</code></pre></div><h2 id="引脚映射模块"><a href="#引脚映射模块" class="header-anchor">#</a> 引脚映射模块</h2> <div class="language- extra-class"><pre><code>cpu_map.h：定义MCU的引脚对应关系
</code></pre></div><h2 id="辅助模块"><a href="#辅助模块" class="header-anchor">#</a> 辅助模块</h2> <div class="language- extra-class"><pre><code>nuts_bolts.c：一些全局变量定义，到处被用到的有用的常量、宏。 
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/analysis/" class="prev router-link-active">
        开始
      </a></span> <span class="next"><a href="/analysis/main.html">
        入口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d7d3e404.js" defer></script><script src="/assets/js/2.2179b996.js" defer></script><script src="/assets/js/8.66aa924d.js" defer></script>
  </body>
</html>
