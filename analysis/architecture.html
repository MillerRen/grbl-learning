<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构 | Grbl 源码解析与移植</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="Grbl源码精度与解析，代码行级中文注释并提供丰富详尽的案例展示。">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.9025fca6.js" as="script"><link rel="preload" href="/assets/js/2.2179b996.js" as="script"><link rel="preload" href="/assets/js/8.ba3f58b3.js" as="script"><link rel="prefetch" href="/assets/js/10.506d157f.js"><link rel="prefetch" href="/assets/js/11.94485d27.js"><link rel="prefetch" href="/assets/js/12.7b1fc706.js"><link rel="prefetch" href="/assets/js/13.c6140b6d.js"><link rel="prefetch" href="/assets/js/14.d07f98cd.js"><link rel="prefetch" href="/assets/js/15.5a807fbe.js"><link rel="prefetch" href="/assets/js/16.e78a27f6.js"><link rel="prefetch" href="/assets/js/17.ee4b6d1f.js"><link rel="prefetch" href="/assets/js/18.f8873908.js"><link rel="prefetch" href="/assets/js/19.7715a2d5.js"><link rel="prefetch" href="/assets/js/20.c4557d58.js"><link rel="prefetch" href="/assets/js/21.026d9e3b.js"><link rel="prefetch" href="/assets/js/22.3cfcf25e.js"><link rel="prefetch" href="/assets/js/23.4bd6be5d.js"><link rel="prefetch" href="/assets/js/24.b53af0cd.js"><link rel="prefetch" href="/assets/js/25.13b5e8ac.js"><link rel="prefetch" href="/assets/js/26.9fc3e80f.js"><link rel="prefetch" href="/assets/js/27.43445fc6.js"><link rel="prefetch" href="/assets/js/28.e7443675.js"><link rel="prefetch" href="/assets/js/29.61bde2d7.js"><link rel="prefetch" href="/assets/js/3.281ea079.js"><link rel="prefetch" href="/assets/js/30.2e24a202.js"><link rel="prefetch" href="/assets/js/31.04abe46c.js"><link rel="prefetch" href="/assets/js/32.48fdc75e.js"><link rel="prefetch" href="/assets/js/33.4925b93a.js"><link rel="prefetch" href="/assets/js/34.cad5a87d.js"><link rel="prefetch" href="/assets/js/35.64d99878.js"><link rel="prefetch" href="/assets/js/36.9793640a.js"><link rel="prefetch" href="/assets/js/37.d64dba23.js"><link rel="prefetch" href="/assets/js/38.288a21e6.js"><link rel="prefetch" href="/assets/js/39.56d06a43.js"><link rel="prefetch" href="/assets/js/4.684c220d.js"><link rel="prefetch" href="/assets/js/40.31f94a78.js"><link rel="prefetch" href="/assets/js/41.efc6288a.js"><link rel="prefetch" href="/assets/js/5.44e5e94b.js"><link rel="prefetch" href="/assets/js/6.c60b674b.js"><link rel="prefetch" href="/assets/js/7.cc83311f.js"><link rel="prefetch" href="/assets/js/9.79ed1b22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Grbl 源码解析与移植" class="logo"> <span class="site-name can-hide">Grbl 源码解析与移植</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  grbl中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  grbl中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/preface.html" class="sidebar-link">前言</a></li><li><a href="/prepare.html" class="sidebar-link">准备工作</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/analysis/" class="sidebar-heading clickable router-link-active open"><span>Grbl源码解析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/analysis/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/analysis/architecture.html" aria-current="page" class="active sidebar-link">架构</a></li><li><a href="/analysis/main.html" class="sidebar-link">主入口</a></li><li><a href="/analysis/serial.html" class="sidebar-link">串口</a></li><li><a href="/analysis/protocol.html" class="sidebar-link">协议</a></li><li><a href="/analysis/system.html" class="sidebar-link">状态机</a></li><li><a href="/analysis/gcode.html" class="sidebar-link">G代码解析</a></li><li><a href="/analysis/motion.html" class="sidebar-link">运动控制</a></li><li><a href="/analysis/planner.html" class="sidebar-link">运动规划</a></li><li><a href="/analysis/acceleration.html" class="sidebar-link">加速度算法</a></li><li><a href="/analysis/bresenham.html" class="sidebar-link">bresenham插值算法</a></li><li><a href="/analysis/stepper.html" class="sidebar-link">运动执行-步进电机</a></li><li><a href="/analysis/spindle.html" class="sidebar-link">主轴</a></li><li><a href="/analysis/coolant.html" class="sidebar-link">冷却</a></li><li><a href="/analysis/endstop.html" class="sidebar-link">限位开关</a></li><li><a href="/analysis/homing.html" class="sidebar-link">归位</a></li><li><a href="/analysis/probe.html" class="sidebar-link">对刀</a></li><li><a href="/analysis/emergency.html" class="sidebar-link">安全-紧急事件</a></li><li><a href="/analysis/settings.html" class="sidebar-link">参数设置</a></li><li><a href="/analysis/interface.html" class="sidebar-link">上位机接口</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/porting/" class="sidebar-heading clickable"><span>Grbl移植</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/extensions/" class="sidebar-heading clickable"><span>Grbl扩展</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/appendix/" class="sidebar-link">附录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h1> <p>Grbl的核心是带有梯形加减速过程的直线插补算法的实现，它包含一个G代码的解析器，一个全局状态机，还有一系列的守护进程,是一个典型的前台+后台架构。通过调用链分析，得到下图：</p> <p><img src="/assets/img/grbl-architecture.1d906c3c.png" alt="grbl architecture"></p> <p>Grbl运行在 Arduino UNO 硬件上，但是它并没有使用Arduino框架，原因在于Arduino的芯片atmega328p资源有限，而且Arduino框架占用了某些资源（比如定时器）。因此grbl所有的库都是自己封装的，通过操作寄存器实现的。通过grbl源码，我整理出了以下模块的作用：</p> <ul><li><p><strong>主入口：</strong></p> <p>main.c 初始化外设，开启主循环</p></li> <li><p><strong>串口通信：</strong></p> <p>serial.c：低阶串口通信并为异步控制检出运行时的实时命令。</p> <p>report.c：通知状态映射和消息组装</p> <p>print.c：打印不同格式字符串的函数（用在串口）</p></li> <li><p><strong>主循环：</strong></p> <p>protocol.c: 从串口接受命令行并把他们传递到“gcode”执行。提供每个命令的状态响应。还管理串口中断的运行时命令集。</p> <p>gcode.c：从“protocol”接收g代码，按照解析器的当前状态解析它并且通过“xxx_control”模块发出命令</p></li> <li><p><strong>运动规划模块：</strong></p> <p>motion_control.c: 从“gcode”接收移动命令并且传递他们到规划器。这个模块为规划器模块或步进电机模块提供公共接口。</p> <p>planner.c: 从“motion_control”接收线性移动命令并且把他们添加到准备移动的计划中。它维护持被添加的移动续优化加速度路径。</p></li> <li><p><strong>动作模块：</strong></p> <p>stepper.c：按计划用步进电机按步执行移动</p> <p>spindle.c: 控制主轴的命令</p> <p>coolant_control.c：控制主轴冷却的命令</p></li> <li><p><strong>输入控制模块：</strong></p> <p>limits.c：配置限位开关，用来告诉机器源点位置，阻止超出行程范围</p> <p>probe.c：对刀，告知Z轴0点位置</p> <p>jog.c：手动控制机器移动</p> <p>system.c：解析并执行系统命令（$开头），外部控制按钮响应</p></li> <li><p><strong>参数设置模块：</strong></p> <p>settings.c：在eeroom中维护运行时配置项并且让它对所有模块可用</p> <p>config.h：编译时的用户配置</p> <p>eeprom.c：一个Atmel的库，提供方法读或写eerom，添加了一点东西可以在读写二进制流的时候检查配置项的校验和。</p></li> <li><p><strong>引脚映射模块：</strong></p> <p>cpu_map.h：定义MCU的引脚对应关系</p></li> <li><p><strong>辅助模块：</strong></p> <p>nuts_bolts.c：一些全局变量定义，到处被用到的有用的常量、宏。</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/analysis/" class="prev router-link-active">
        开始
      </a></span> <span class="next"><a href="/analysis/main.html">
        主入口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9025fca6.js" defer></script><script src="/assets/js/2.2179b996.js" defer></script><script src="/assets/js/8.ba3f58b3.js" defer></script>
  </body>
</html>
