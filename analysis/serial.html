<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>串口 | GRBL 源码解析与移植</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="GRBL源码精度与解析，代码行级中文注释并提供丰富详尽的案例展示。">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.d7d3e404.js" as="script"><link rel="preload" href="/assets/js/2.2179b996.js" as="script"><link rel="preload" href="/assets/js/24.fc512beb.js" as="script"><link rel="prefetch" href="/assets/js/10.43721e34.js"><link rel="prefetch" href="/assets/js/11.94485d27.js"><link rel="prefetch" href="/assets/js/12.62821b06.js"><link rel="prefetch" href="/assets/js/13.8de29ef2.js"><link rel="prefetch" href="/assets/js/14.de9f355a.js"><link rel="prefetch" href="/assets/js/15.10c69e8b.js"><link rel="prefetch" href="/assets/js/16.81e91af6.js"><link rel="prefetch" href="/assets/js/17.946d1ce0.js"><link rel="prefetch" href="/assets/js/18.e33a28bd.js"><link rel="prefetch" href="/assets/js/19.77386b6f.js"><link rel="prefetch" href="/assets/js/20.091e6fb2.js"><link rel="prefetch" href="/assets/js/21.06db4577.js"><link rel="prefetch" href="/assets/js/22.222069d8.js"><link rel="prefetch" href="/assets/js/23.70e115df.js"><link rel="prefetch" href="/assets/js/25.d60ff0f6.js"><link rel="prefetch" href="/assets/js/26.e56b5ba3.js"><link rel="prefetch" href="/assets/js/27.f03d4f84.js"><link rel="prefetch" href="/assets/js/28.efb12f8a.js"><link rel="prefetch" href="/assets/js/29.4cef9913.js"><link rel="prefetch" href="/assets/js/3.7769cc81.js"><link rel="prefetch" href="/assets/js/30.d669c7ff.js"><link rel="prefetch" href="/assets/js/31.d06babf5.js"><link rel="prefetch" href="/assets/js/32.166a6dc2.js"><link rel="prefetch" href="/assets/js/33.533dc180.js"><link rel="prefetch" href="/assets/js/34.1b934459.js"><link rel="prefetch" href="/assets/js/35.12a39adc.js"><link rel="prefetch" href="/assets/js/36.c3bd12bc.js"><link rel="prefetch" href="/assets/js/37.5d15a6fd.js"><link rel="prefetch" href="/assets/js/38.9cbd22d9.js"><link rel="prefetch" href="/assets/js/39.fdd5b48e.js"><link rel="prefetch" href="/assets/js/4.7e1f184d.js"><link rel="prefetch" href="/assets/js/40.8b1c15b8.js"><link rel="prefetch" href="/assets/js/41.7c9440bb.js"><link rel="prefetch" href="/assets/js/42.209b84b2.js"><link rel="prefetch" href="/assets/js/43.9eabc9ae.js"><link rel="prefetch" href="/assets/js/44.08fb7642.js"><link rel="prefetch" href="/assets/js/45.93f46a58.js"><link rel="prefetch" href="/assets/js/5.44e5e94b.js"><link rel="prefetch" href="/assets/js/6.c60b674b.js"><link rel="prefetch" href="/assets/js/7.7e458f75.js"><link rel="prefetch" href="/assets/js/8.66aa924d.js"><link rel="prefetch" href="/assets/js/9.79ed1b22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="GRBL 源码解析与移植" class="logo"> <span class="site-name can-hide">GRBL 源码解析与移植</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/preface.html" class="sidebar-link">前言</a></li><li><a href="/prepare.html" class="sidebar-link">准备工作</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/analysis/" class="sidebar-heading clickable router-link-active open"><span>GRBL源码解析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/analysis/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/analysis/architecture.html" class="sidebar-link">架构</a></li><li><a href="/analysis/main.html" class="sidebar-link">入口</a></li><li><a href="/analysis/protocol.html" class="sidebar-link">协议-主循环</a></li><li><a href="/analysis/serial.html" aria-current="page" class="active sidebar-link">串口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/analysis/serial.html#环形队列" class="sidebar-link">环形队列</a></li><li class="sidebar-sub-header"><a href="/analysis/serial.html#源代码" class="sidebar-link">源代码</a></li><li class="sidebar-sub-header"><a href="/analysis/serial.html#串口初始化" class="sidebar-link">串口初始化</a></li><li class="sidebar-sub-header"><a href="/analysis/serial.html#接收缓冲器" class="sidebar-link">接收缓冲器</a></li></ul></li><li><a href="/analysis/system.html" class="sidebar-link">状态机</a></li><li><a href="/analysis/gcode.html" class="sidebar-link">G代码解析</a></li><li><a href="/analysis/motion.html" class="sidebar-link">运动控制</a></li><li><a href="/analysis/planner.html" class="sidebar-link">运动规划</a></li><li><a href="/analysis/acceleration.html" class="sidebar-link">加速度算法</a></li><li><a href="/analysis/bresenham.html" class="sidebar-link">bresenham插值算法</a></li><li><a href="/analysis/stepper.html" class="sidebar-link">运动执行-步进电机</a></li><li><a href="/analysis/spindle.html" class="sidebar-link">主轴</a></li><li><a href="/analysis/coolant.html" class="sidebar-link">冷却</a></li><li><a href="/analysis/endstop.html" class="sidebar-link">限位开关</a></li><li><a href="/analysis/homing.html" class="sidebar-link">归位</a></li><li><a href="/analysis/probe.html" class="sidebar-link">对刀</a></li><li><a href="/analysis/emergency.html" class="sidebar-link">安全-紧急事件</a></li><li><a href="/analysis/settings.html" class="sidebar-link">参数设置</a></li><li><a href="/analysis/interface.html" class="sidebar-link">上位机接口</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/porting/" class="sidebar-heading clickable"><span>GRBL移植</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/extensions/" class="sidebar-heading clickable"><span>GRBL扩展</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/appendix/" class="sidebar-link">附录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="串口"><a href="#串口" class="header-anchor">#</a> 串口</h1> <p>grbl使用串口从上位机接收信息，并通过串口反馈给上位机，它使用各自的 <code>环形队列</code> 作为缓冲器，用以匹配不同系统的处理能力。</p> <h2 id="环形队列"><a href="#环形队列" class="header-anchor">#</a> 环形队列</h2> <p>环形队列是在实际编程极为有用的数据结构,它是一个首尾相连的FIFO的数据结构，采用数组的线性空间,数据组织简单。能很快知道队列是否满为空。能以很快速度的来存取数据。</p> <ol><li><p>缓冲：使用队列可以缓冲数据，提升收发数据的性能。</p></li> <li><p>高效：相比直线队列，空间利用率高。</p></li> <li><p>多任务：配合中断，串口和主循环可以在互不干扰的情况下独立工作。</p></li></ol> <p>grbl中的环形队列使用数组实现，使用两个指针标记队头队尾（不过grbl这里是反的），通过保持一个粗存单元为空策略判断队列满和空。</p> <ul><li>队列满：tail+1==head</li> <li>队列空：head==tail</li></ul> <p>下面以大小为8字节的队列进行说明：</p> <ol><li>初始状态：</li></ol> <table><thead><tr><th>head+tail</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <p>此时head==tail，队列为空。</p> <ol start="2"><li>插入一个元素：
判断tail+1!=head,数据插入队尾tail的位置, tail++。</li></ol> <table><thead><tr><th>head</th> <th>tail</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>*</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <ol start="3"><li>再插入一个元素：
判断tail+1!=head,数据插入队尾tail的位置, tail++。</li></ol> <table><thead><tr><th>head</th> <th></th> <th>tail</th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>*</td> <td>*</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <ol start="4"><li>取出一个元素：
判断head!=tail队列不为空,取出head位置的值, head++。</li></ol> <table><thead><tr><th></th> <th>head</th> <th>tail</th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td></td> <td>*</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <ol start="5"><li>继续插入元素：
判断tail+1!=head,数据插入队尾tail的位置。</li></ol> <table><thead><tr><th></th> <th>head</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th>tail</th></tr></thead> <tbody><tr><td></td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td></td></tr></tbody></table> <ol start="6"><li>继续插入元素（达到数组最大值）：
判断tail+1!=head,数据插入队尾tail的位置，这时tail+1超过了数组索引值size，要返回来设置tail=0,这样就形成了环形。</li></ol> <table><thead><tr><th>tail</th> <th>head</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td></td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td>*</td> <td>*</td></tr></tbody></table> <ol start="7"><li>取出元素：
判断tail!=head,head++。</li></ol> <table><thead><tr><th>tail</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th>head</th></tr></thead> <tbody><tr><td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td>*</td></tr></tbody></table> <ol start="8"><li>继续取出元素（达到数组最大值）：
判断tail!=head,head+1这时head超过了数组索引值size，要返回来设置head=0,这样就形成了环形。</li></ol> <table><thead><tr><th>tail+head</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <h2 id="源代码"><a href="#源代码" class="header-anchor">#</a> 源代码</h2> <p>串口的实现是在<code>serial.c</code>模块中完成的，它基于 <strong>环形队列</strong> 用 <strong>中断</strong> 方式分别实现了串口接收缓冲器和串口发送缓冲器，接收中断时把数据放入串口接收缓冲区，发送为空中断时，从串口发送缓冲区取一个字节发送到串口。</p> <h2 id="串口初始化"><a href="#串口初始化" class="header-anchor">#</a> 串口初始化</h2> <p>串口(USART)是通用异步串行接收发送标准化接口，因为是异步的，所以要定义好波特率、停止位、校验位等参数，两个设备波特率一致才能正常通信。</p> <p>与串口相关的寄存器：</p> <ul><li><p>UCSRnA and UCSRnB and UCSRnC: USART Control and Status Register n A 串口控制与状态寄存器</p></li> <li><p>UDRn: USART I/O Data Register n 串口IO数据寄存器</p></li> <li><p>UBRRnL and UBRRnH – USART Baud Rate Registers 串口波特率寄存器</p></li></ul> <p>grbl现在默认的波特率是115200，现在电脑和单片机的性能已经够好，没必要再使用9600了，并且这个速度对已经足够用了。根据官方给出的波特率计算公式计算得出<code>ubrrn = fosc/(8*baud)-1。16000000/(8*115200)-1 = 16.36111111111111</code>取整后得到值为16(查表也能得到)，由于计算出来的值有可能大于8位所以需要两个8位寄存器接收波特率值,高波特率需要开启倍频。默认的8位无校验位1停止位就可以了，没必要重新配置。最后使能串口接收和串口发送中断。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 串口初始化</span>
<span class="token keyword">void</span> <span class="token function">serial_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 设置波特率</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">BAUD_RATE <span class="token operator">&lt;</span> <span class="token number">57600</span></span></span>
    <span class="token class-name">uint16_t</span> UBRR0_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>F_CPU <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">8L</span> <span class="token operator">*</span> BAUD_RATE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">;</span>
    UCSR0A <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> U2X0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭波特率倍增器。 - 只在Uno xxx上需要。</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token class-name">uint16_t</span> UBRR0_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>F_CPU <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4L</span> <span class="token operator">*</span> BAUD_RATE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    UCSR0A <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> U2X0<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 波特率高的波特率倍增器开启，即115200</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">// 波特率是比较大的数字，需要两个8位寄存器存放</span>
  UBRR0H <span class="token operator">=</span> UBRR0_value <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 高8位右移到低8位，放入高8位寄存器，右移不会改变源数值</span>
  UBRR0L <span class="token operator">=</span> UBRR0_value<span class="token punctuation">;</span> <span class="token comment">// 第八位直接放入低8位寄存器</span>

  <span class="token comment">// 启用接收，发送和接收完成一个字节的中断</span>
  UCSR0B <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>RXEN0 <span class="token operator">|</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>TXEN0 <span class="token operator">|</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>RXCIE0<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 默认协议是8位，无奇偶校验，1个停止位</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="接收缓冲器"><a href="#接收缓冲器" class="header-anchor">#</a> 接收缓冲器</h2> <p>首先定义了一个<code>RX_BUFFER_SIZE</code>大小(128字节)的环形队列，并使用了队头和队尾两个指针记录队列状态：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">RX_BUFFER_SIZE</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RX_BUFFER_SIZE</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RX_RING_BUFFER</span> <span class="token expression"><span class="token punctuation">(</span>RX_BUFFER_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">// 定义接收缓冲区环形队列长度</span></span>
<span class="token class-name">uint8_t</span> serial_rx_buffer<span class="token punctuation">[</span>RX_RING_BUFFER<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 定义串口接收环形队列</span>
<span class="token class-name">uint8_t</span> serial_rx_buffer_head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 定义串口接收环形队列头指针</span>
<span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span> serial_rx_buffer_tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 定义串口接收环形队列尾指针</span>
</code></pre></div><p>一个读取缓冲器的接口：这个接口在主循环中调用，它从串口接收一个字节就更新一下队尾的指针，因为使用的是数组，指针到达数组尾部要返回数组头部形成环形，如果队列是空的<code>serial_rx_buffer_head == tail</code>，就返回结束符号<code>0xff</code>。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 获取串口接收缓冲区的第一个字节。被主程序调用。</span>
<span class="token class-name">uint8_t</span> <span class="token function">serial_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">uint8_t</span> tail <span class="token operator">=</span> serial_rx_buffer_tail<span class="token punctuation">;</span> <span class="token comment">// 临时变量暂存 serial_rx_buffer_tail (优化volatile)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>serial_rx_buffer_head <span class="token operator">==</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果接收环形队列为空，则设置结束符号</span>
    <span class="token keyword">return</span> SERIAL_NO_DATA<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> serial_rx_buffer<span class="token punctuation">[</span>tail<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 从接受环形队列取一个字节</span>

    tail<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 更新尾指针</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tail <span class="token operator">==</span> RX_RING_BUFFER<span class="token punctuation">)</span> <span class="token punctuation">{</span> tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 环形</span>
    serial_rx_buffer_tail <span class="token operator">=</span> tail<span class="token punctuation">;</span>

    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>串口接收数据是在串口接收的中断中处理的,一旦串口中接收到了一个字节数据，就会触发中断，从串口数据寄存器中取出数据后，会做简单区分，这里有三种类型的数据：</p> <ol><li>实时命令，不会放入缓冲区</li> <li>实时覆盖命令，能实时调整部分参数，也不会放入串口接收缓冲器</li> <li>正常的G代码和系统命令，会放入串口接收缓冲器。</li></ol> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 串口数据接收中断处理</span>
<span class="token function">ISR</span><span class="token punctuation">(</span>SERIAL_RX<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> UDR0<span class="token punctuation">;</span> <span class="token comment">// 从串口数据寄存器取出数据</span>
  <span class="token class-name">uint8_t</span> next_head<span class="token punctuation">;</span> <span class="token comment">// 初始化下一个头指针</span>

  <span class="token comment">// 直接从串行流中选取实时命令字符。这些字符不被传递到主缓冲区，但是它们设置了实时执行的系统状态标志位。</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> CMD_RESET<span class="token operator">:</span>         <span class="token function">mc_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 调用运动控制重置程序</span>
    <span class="token keyword">case</span> CMD_STATUS_REPORT<span class="token operator">:</span> <span class="token function">system_set_exec_state_flag</span><span class="token punctuation">(</span>EXEC_STATUS_REPORT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 设置为 true</span>
    <span class="token keyword">case</span> CMD_CYCLE_START<span class="token operator">:</span>   <span class="token function">system_set_exec_state_flag</span><span class="token punctuation">(</span>EXEC_CYCLE_START<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 设置为 true</span>
    <span class="token keyword">case</span> CMD_FEED_HOLD<span class="token operator">:</span>     <span class="token function">system_set_exec_state_flag</span><span class="token punctuation">(</span>EXEC_FEED_HOLD<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 设置为 true</span>
    <span class="token keyword">default</span> <span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&gt;</span> <span class="token number">0x7F</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 实时控制都是扩展的ASCII字符</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> CMD_SAFETY_DOOR<span class="token operator">:</span>   <span class="token function">system_set_exec_state_flag</span><span class="token punctuation">(</span>EXEC_SAFETY_DOOR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 设置为 true</span>
          <span class="token keyword">case</span> CMD_JOG_CANCEL<span class="token operator">:</span>   
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>state <span class="token operator">&amp;</span> STATE_JOG<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 阻止所有其他状态，调用运动取消。</span>
              <span class="token function">system_set_exec_state_flag</span><span class="token punctuation">(</span>EXEC_MOTION_CANCEL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
          <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
            <span class="token keyword">case</span> CMD_DEBUG_REPORT<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token class-name">uint8_t</span> sreg <span class="token operator">=</span> SREG<span class="token punctuation">;</span> <span class="token function">cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">bit_true</span><span class="token punctuation">(</span>sys_rt_exec_debug<span class="token punctuation">,</span>EXEC_DEBUG_REPORT<span class="token punctuation">)</span><span class="token punctuation">;</span> SREG <span class="token operator">=</span> sreg<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
          <span class="token comment">// 以下为实时覆盖命令</span>
          <span class="token keyword">case</span> CMD_FEED_OVR_RESET<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_FEED_OVR_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_FEED_OVR_COARSE_PLUS<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_FEED_OVR_COARSE_PLUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_FEED_OVR_COARSE_MINUS<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_FEED_OVR_COARSE_MINUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_FEED_OVR_FINE_PLUS<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_FEED_OVR_FINE_PLUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_FEED_OVR_FINE_MINUS<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_FEED_OVR_FINE_MINUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_RAPID_OVR_RESET<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_RAPID_OVR_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_RAPID_OVR_MEDIUM<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_RAPID_OVR_MEDIUM<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_RAPID_OVR_LOW<span class="token operator">:</span> <span class="token function">system_set_exec_motion_override_flag</span><span class="token punctuation">(</span>EXEC_RAPID_OVR_LOW<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_RESET<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_COARSE_PLUS<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_COARSE_PLUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_COARSE_MINUS<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_COARSE_MINUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_FINE_PLUS<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_FINE_PLUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_FINE_MINUS<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_FINE_MINUS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_SPINDLE_OVR_STOP<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_SPINDLE_OVR_STOP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> CMD_COOLANT_FLOOD_OVR_TOGGLE<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_COOLANT_FLOOD_OVR_TOGGLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ENABLE_M7</span></span>
            <span class="token keyword">case</span> CMD_COOLANT_MIST_OVR_TOGGLE<span class="token operator">:</span> <span class="token function">system_set_exec_accessory_override_flag</span><span class="token punctuation">(</span>EXEC_COOLANT_MIST_OVR_TOGGLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 除了上面已知的实时命令，其他的ASCII扩展字符都被丢掉</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 其他的字符被认为都是G代码，会被写入到主缓冲区</span>
        next_head <span class="token operator">=</span> serial_rx_buffer_head <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 更新临时头指针</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next_head <span class="token operator">==</span> RX_RING_BUFFER<span class="token punctuation">)</span> <span class="token punctuation">{</span> next_head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">// 写入到接收缓冲区，直到它满了为止。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next_head <span class="token operator">!=</span> serial_rx_buffer_tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          serial_rx_buffer<span class="token punctuation">[</span>serial_rx_buffer_head<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
          serial_rx_buffer_head <span class="token operator">=</span> next_head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/analysis/protocol.html" class="prev">
        协议-主循环
      </a></span> <span class="next"><a href="/analysis/system.html">
        状态机
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d7d3e404.js" defer></script><script src="/assets/js/2.2179b996.js" defer></script><script src="/assets/js/24.fc512beb.js" defer></script>
  </body>
</html>
