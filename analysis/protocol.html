<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>协议-主循环 protocol.c | GRBL 源码解析与移植</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="GRBL源码精度与解析，代码行级中文注释并提供丰富详尽的案例展示。">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.0e50ef70.js" as="script"><link rel="preload" href="/assets/js/2.2179b996.js" as="script"><link rel="preload" href="/assets/js/23.03027e3a.js" as="script"><link rel="prefetch" href="/assets/js/10.29da2088.js"><link rel="prefetch" href="/assets/js/11.baa5aeba.js"><link rel="prefetch" href="/assets/js/12.2473a001.js"><link rel="prefetch" href="/assets/js/13.8de29ef2.js"><link rel="prefetch" href="/assets/js/14.1c279b4d.js"><link rel="prefetch" href="/assets/js/15.15bd45b8.js"><link rel="prefetch" href="/assets/js/16.52100af2.js"><link rel="prefetch" href="/assets/js/17.28580bc5.js"><link rel="prefetch" href="/assets/js/18.1338e7be.js"><link rel="prefetch" href="/assets/js/19.443742ce.js"><link rel="prefetch" href="/assets/js/20.189f515c.js"><link rel="prefetch" href="/assets/js/21.cdb5ac30.js"><link rel="prefetch" href="/assets/js/22.47bb3c43.js"><link rel="prefetch" href="/assets/js/24.1b069083.js"><link rel="prefetch" href="/assets/js/25.2b490130.js"><link rel="prefetch" href="/assets/js/26.e847c9db.js"><link rel="prefetch" href="/assets/js/27.742a49cf.js"><link rel="prefetch" href="/assets/js/28.efb12f8a.js"><link rel="prefetch" href="/assets/js/29.5bc05e16.js"><link rel="prefetch" href="/assets/js/3.9c591424.js"><link rel="prefetch" href="/assets/js/30.a73294e3.js"><link rel="prefetch" href="/assets/js/31.04abe46c.js"><link rel="prefetch" href="/assets/js/32.effc5604.js"><link rel="prefetch" href="/assets/js/33.c83f7f1c.js"><link rel="prefetch" href="/assets/js/34.825bd512.js"><link rel="prefetch" href="/assets/js/35.7985efe7.js"><link rel="prefetch" href="/assets/js/36.c3bd12bc.js"><link rel="prefetch" href="/assets/js/37.081e6343.js"><link rel="prefetch" href="/assets/js/38.b426bd89.js"><link rel="prefetch" href="/assets/js/39.d27b688d.js"><link rel="prefetch" href="/assets/js/4.7e1f184d.js"><link rel="prefetch" href="/assets/js/40.629d4ac3.js"><link rel="prefetch" href="/assets/js/41.209beaca.js"><link rel="prefetch" href="/assets/js/42.209b84b2.js"><link rel="prefetch" href="/assets/js/43.e43033c9.js"><link rel="prefetch" href="/assets/js/44.ed607dcc.js"><link rel="prefetch" href="/assets/js/45.561488af.js"><link rel="prefetch" href="/assets/js/5.44e5e94b.js"><link rel="prefetch" href="/assets/js/6.c60b674b.js"><link rel="prefetch" href="/assets/js/7.01d3aa97.js"><link rel="prefetch" href="/assets/js/8.7f15bb3b.js"><link rel="prefetch" href="/assets/js/9.79ed1b22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="GRBL 源码解析与移植" class="logo"> <span class="site-name can-hide">GRBL 源码解析与移植</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/donate/" class="nav-link">
  打赏
</a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GRBL中文注解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MillerRen/grbl-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/preface.html" class="sidebar-link">前言</a></li><li><a href="/prepare.html" class="sidebar-link">准备工作</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/analysis/" class="sidebar-heading clickable router-link-active open"><span>GRBL源码解析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/analysis/" aria-current="page" class="sidebar-link">开始</a></li><li><a href="/analysis/architecture.html" class="sidebar-link">架构</a></li><li><a href="/analysis/main.html" class="sidebar-link">入口</a></li><li><a href="/analysis/protocol.html" aria-current="page" class="active sidebar-link">协议-主循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/analysis/protocol.html#源代码" class="sidebar-link">源代码</a></li><li class="sidebar-sub-header"><a href="/analysis/protocol.html#安全检查" class="sidebar-link">安全检查</a></li><li class="sidebar-sub-header"><a href="/analysis/protocol.html#处理串口字符串" class="sidebar-link">处理串口字符串</a></li><li class="sidebar-sub-header"><a href="/analysis/protocol.html#开始自动周期" class="sidebar-link">开始自动周期</a></li><li class="sidebar-sub-header"><a href="/analysis/protocol.html#终止信号" class="sidebar-link">终止信号</a></li><li class="sidebar-sub-header"><a href="/analysis/protocol.html#运行时检查" class="sidebar-link">运行时检查</a></li></ul></li><li><a href="/analysis/serial.html" class="sidebar-link">串口</a></li><li><a href="/analysis/system.html" class="sidebar-link">状态机</a></li><li><a href="/analysis/gcode.html" class="sidebar-link">G代码解析</a></li><li><a href="/analysis/motion.html" class="sidebar-link">运动控制</a></li><li><a href="/analysis/planner.html" class="sidebar-link">运动规划</a></li><li><a href="/analysis/acceleration.html" class="sidebar-link">加速度算法</a></li><li><a href="/analysis/bresenham.html" class="sidebar-link">bresenham插值算法</a></li><li><a href="/analysis/stepper.html" class="sidebar-link">运动执行-步进电机</a></li><li><a href="/analysis/spindle.html" class="sidebar-link">主轴</a></li><li><a href="/analysis/coolant.html" class="sidebar-link">冷却</a></li><li><a href="/analysis/endstop.html" class="sidebar-link">限位开关</a></li><li><a href="/analysis/homing.html" class="sidebar-link">归位</a></li><li><a href="/analysis/probe.html" class="sidebar-link">对刀</a></li><li><a href="/analysis/emergency.html" class="sidebar-link">安全-紧急事件</a></li><li><a href="/analysis/settings.html" class="sidebar-link">参数设置</a></li><li><a href="/analysis/interface.html" class="sidebar-link">上位机接口</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/porting/" class="sidebar-heading clickable"><span>GRBL移植</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/extensions/" class="sidebar-heading clickable"><span>GRBL扩展</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/appendix/" class="sidebar-link">附录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="协议-主循环-protocol-c"><a href="#协议-主循环-protocol-c" class="header-anchor">#</a> 协议-主循环 <code>protocol.c</code></h1> <p>主循环函数<code>protocol_main_loop()</code>主要的功能就是从 <strong>GRBL串口RX缓冲区</strong> （不是芯片缓冲区）读取字符串，经过处理后放入 <strong>G代码行缓冲区</strong>，然后交给<strong>G代码解析器</strong>，并且根据各个子模块状态机做出响应。</p> <h2 id="源代码"><a href="#源代码" class="header-anchor">#</a> 源代码</h2> <p><code>protocol_main_loop()</code>函数是在<code>protocol.c</code>中定义的，该模块用于控制和执行协议和程序。我们先看下源码：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// Define line flags. Includes comment type tracking and line overflow detection.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LINE_FLAG_OVERFLOW</span> <span class="token expression"><span class="token function">bit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LINE_FLAG_COMMENT_PARENTHESES</span> <span class="token expression"><span class="token function">bit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LINE_FLAG_COMMENT_SEMICOLON</span> <span class="token expression"><span class="token function">bit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LINE_BUFFER_SIZE</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LINE_BUFFER_SIZE</span> <span class="token expression"><span class="token number">80</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> line<span class="token punctuation">[</span>LINE_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Line to be executed. Zero-terminated.</span>


<span class="token comment">/*
  GRBL PRIMARY LOOP:
*/</span>
<span class="token keyword">void</span> <span class="token function">protocol_main_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Perform some machine checks to make sure everything is good to go.</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECK_LIMITS_AT_INIT</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bit_istrue</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> BITFLAG_HARD_LIMIT_ENABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">limits_get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_ALARM<span class="token punctuation">;</span> <span class="token comment">// Ensure alarm state is active.</span>
        <span class="token function">report_feedback_message</span><span class="token punctuation">(</span>MESSAGE_CHECK_LIMITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">// Check for and report alarm state after a reset, error, or an initial power up.</span>
  <span class="token comment">// NOTE: Sleep mode disables the stepper drivers and position can't be guaranteed.</span>
  <span class="token comment">// Re-initialize the sleep state as an ALARM mode to ensure user homes or acknowledges.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>state <span class="token operator">&amp;</span> <span class="token punctuation">(</span>STATE_ALARM <span class="token operator">|</span> STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">report_feedback_message</span><span class="token punctuation">(</span>MESSAGE_ALARM_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_ALARM<span class="token punctuation">;</span> <span class="token comment">// Ensure alarm state is set.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if the safety door is open.</span>
    sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_IDLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">system_check_safety_door_ajar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">bit_true</span><span class="token punctuation">(</span>sys_rt_exec_state<span class="token punctuation">,</span> EXEC_SAFETY_DOOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Enter safety door mode. Should return as IDLE state.</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// All systems go!</span>
    <span class="token function">system_execute_startup</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Execute startup script.</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ---------------------------------------------------------------------------------</span>
  <span class="token comment">// Primary loop! Upon a system abort, this exits back to main() to reset the system.</span>
  <span class="token comment">// This is also where Grbl idles while waiting for something to do.</span>
  <span class="token comment">// ---------------------------------------------------------------------------------</span>

  <span class="token class-name">uint8_t</span> line_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> char_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> c<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Process one line of incoming serial data, as the data becomes available. Performs an</span>
    <span class="token comment">// initial filtering by removing spaces and comments and capitalizing all letters.</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">serial_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SERIAL_NO_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// End of line reached</span>

        <span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Runtime command check point.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Bail to calling function upon system abort</span>

        line<span class="token punctuation">[</span>char_counter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Set string termination character.</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">REPORT_ECHO_LINE_RECEIVED</span></span>
          <span class="token function">report_echo_line_received</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

        <span class="token comment">// Direct and execute one line of formatted input, and report status of execution.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags <span class="token operator">&amp;</span> LINE_FLAG_OVERFLOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Report line overflow error.</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_OVERFLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Empty or comment line. For syncing purposes.</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Grbl '$' system command</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span><span class="token function">system_execute_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>state <span class="token operator">&amp;</span> <span class="token punctuation">(</span>STATE_ALARM <span class="token operator">|</span> STATE_JOG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Everything else is gcode. Block if in alarm or jog mode.</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_SYSTEM_GC_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Parse and execute g-code block.</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span><span class="token function">gc_execute_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Reset tracking data for next line.</span>
        line_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        char_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Throw away all (except EOL) comment characters and overflow characters.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">')'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// End of '()' comment. Resume line allowed.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags <span class="token operator">&amp;</span> LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">)</span> <span class="token punctuation">{</span> line_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Throw away whitepace and control characters</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Block delete NOT SUPPORTED. Ignore character.</span>
            <span class="token comment">// NOTE: If supported, would simply need to check the system if block delete is enabled.</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enable comments flag and ignore all characters until ')' or EOL.</span>
            <span class="token comment">// NOTE: This doesn't follow the NIST definition exactly, but is good enough for now.</span>
            <span class="token comment">// In the future, we could simply remove the items within the comments, but retain the</span>
            <span class="token comment">// comment control characters, so that the g-code parser can error-check it.</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">';'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// NOTE: ';' comment to EOL is a LinuxCNC definition. Not NIST.</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_COMMENT_SEMICOLON<span class="token punctuation">;</span>
          <span class="token comment">// TODO: Install '%' feature</span>
          <span class="token comment">// } else if (c == '%') {</span>
            <span class="token comment">// Program start-end percent sign NOT SUPPORTED.</span>
            <span class="token comment">// NOTE: This maybe installed to tell Grbl when a program is running vs manual input,</span>
            <span class="token comment">// where, during a program, the system auto-cycle start will continue to execute</span>
            <span class="token comment">// everything until the next '%' sign. This will help fix resuming issues with certain</span>
            <span class="token comment">// functions that empty the planner buffer to execute its task on-time.</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char_counter <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>LINE_BUFFER_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Detect line buffer overflow and set flag.</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_OVERFLOW<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Upcase lowercase</span>
            line<span class="token punctuation">[</span>char_counter<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token operator">-</span><span class="token char">'a'</span><span class="token operator">+</span><span class="token char">'A'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            line<span class="token punctuation">[</span>char_counter<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If there are no more characters in the serial read buffer to be processed and executed,</span>
    <span class="token comment">// this indicates that g-code streaming has either filled the planner buffer or has</span>
    <span class="token comment">// completed. In either case, auto-cycle start, if enabled, any queued moves.</span>
    <span class="token function">protocol_auto_cycle_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Runtime command check point.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Bail to main() program loop to reset system.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">/* Never reached */</span>
<span class="token punctuation">}</span>
</code></pre></div><p>处理过程大概如下：</p> <h2 id="安全检查"><a href="#安全检查" class="header-anchor">#</a> 安全检查</h2> <p>先执行限位开关、安全门等检查，执行初始化脚本：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 执行一些机器检查以确保一切正常。</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECK_LIMITS_AT_INIT </span><span class="token comment">// 检查是否开启了初始化系统时检查限位开关，默认是开启的。</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bit_istrue</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> BITFLAG_HARD_LIMIT_ENABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查是否设置了硬件限位功能</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">limits_get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查限位开关状态</span>
        sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_ALARM<span class="token punctuation">;</span> <span class="token comment">// 如果限位开关被触发，确保警报状态被激活。</span>
        <span class="token function">report_feedback_message</span><span class="token punctuation">(</span>MESSAGE_CHECK_LIMITS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报告限位开关被触发的反馈消息</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// 在重置、错误、或上电初始化之后检查并报告警报状态。</span>
  <span class="token comment">// 注意： 睡眠模式禁用步进驱动器并且位置不能保持。步进驱动器的EN引脚释放，不能保持力矩。</span>
  <span class="token comment">// 将睡眠状态重新初始化为警报模式确保让用户归位或让用户知道。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>state <span class="token operator">&amp;</span> <span class="token punctuation">(</span>STATE_ALARM <span class="token operator">|</span> STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果系统处于STATE_ALARM或STATE_SLEEP状态</span>
    <span class="token function">report_feedback_message</span><span class="token punctuation">(</span>MESSAGE_ALARM_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报告警报锁定消息</span>
    sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_ALARM<span class="token punctuation">;</span> <span class="token comment">// 确保警报状态被设置</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查安全门是否打开</span>
    sys<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_IDLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">system_check_safety_door_ajar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查安全门</span>
      <span class="token function">bit_true</span><span class="token punctuation">(</span>sys_rt_exec_state<span class="token punctuation">,</span> EXEC_SAFETY_DOOR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置执行安全门标志位</span>
      <span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入安全门模式。应该返回IDLE状态。</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 所有系统正常！</span>
    <span class="token function">system_execute_startup</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行启动脚本</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="处理串口字符串"><a href="#处理串口字符串" class="header-anchor">#</a> 处理串口字符串</h2> <p>一直从RX缓冲区读取字符，直到遇到串口数据结束符<code>SERIAL_NO_DATA(0xff)</code>也就是串口空了为止，然后把读取到的G代码行经过去掉注释和空格、 字母转换为大写后放入G代码行缓冲区<code>line[LINE_BUFFER_SIZE]</code>，如果开头是以<code>$</code>开头的系统命令，则传递给命令处理器入口<code>system_execute_line()</code>，如果是G代码则传递给G代码解释器入口<code>gc_execute_line()</code>。行缓冲区大小<code>LINE_BUFFER_SIZE</code>设置为80个字符，超出这个字符数量会报行缓冲区溢出<code>STATUS_OVERFLOW</code>错误，标准要求是255个字符，但这里足够用了，如果你需要缓冲更多字符，可以修改<code>LINE_BUFFER_SIZE</code>为更大值。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// ---------------------------------------------------------------------------------</span>
  <span class="token comment">// 主循环! 系统终止后这回退出返回到main()去重置系统。</span>
  <span class="token comment">// 这也是Grbl空闲等待其他事情的地方。</span>
  <span class="token comment">// ---------------------------------------------------------------------------------</span>

  <span class="token class-name">uint8_t</span> line_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 初始化行标志位</span>
  <span class="token class-name">uint8_t</span> char_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 初始化字符计数</span>
  <span class="token class-name">uint8_t</span> c<span class="token punctuation">;</span> <span class="token comment">// 声明放字符的变量</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 无限循环</span>

    <span class="token comment">// 处理一行从串口缓冲区到来的数据，如果数据可用的话。通过溢出空格和注释执行一个初始的过滤，并且大写所有字母。</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">serial_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SERIAL_NO_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 从串口读取一个字节，直到遇到结束符</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 到达一行</span>

        <span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 运行时命令检查点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 系统终止后退出函数</span>

        line<span class="token punctuation">[</span>char_counter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 设置字符串结束符号</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">REPORT_ECHO_LINE_RECEIVED</span></span>
          <span class="token function">report_echo_line_received</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报告接收了多少行</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

        <span class="token comment">// 直接执行格式化的输入行并报告执行状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags <span class="token operator">&amp;</span> LINE_FLAG_OVERFLOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 报告行溢出错误</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_OVERFLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 空行或注释行。用于同步。</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Grbl 系统命令 '$'</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span><span class="token function">system_execute_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>state <span class="token operator">&amp;</span> <span class="token punctuation">(</span>STATE_ALARM <span class="token operator">|</span> STATE_JOG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 其他的都是G代码。如果处于警报或点动模式就阻塞。</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span>STATUS_SYSTEM_GC_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 解析并执行G代码块。</span>
          <span class="token function">report_status_message</span><span class="token punctuation">(</span><span class="token function">gc_execute_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 为下一行重置跟踪数据变量</span>
        line_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        char_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 丢弃所有（除了行结束符）注释字符和溢出字符。</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">')'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 匹配括号'()'包裹的注释。继续允许行数据。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line_flags <span class="token operator">&amp;</span> LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">)</span> <span class="token punctuation">{</span> line_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 丢弃空白字符和控制字符</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 丢弃空白字符</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 块删除不支持，忽略字符。</span>
            <span class="token comment">// 注意：如果支持了，应该需要简单地检查系统如果启用了块删除的话。</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 开启注释标志位并忽略所有字符，直到碰到')'或EOL</span>
            <span class="token comment">// 注意：这没有完全遵守NIST定义，但是现在来说足够了。未来我们可能简单地移除注释项，但保留注释控制字符，</span>
            <span class="token comment">// 因此G代码解析器可以进行错误检查。</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_COMMENT_PARENTHESES<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">';'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注意：';' 注释结束符是 LinuxCNC定义的，不是NIST定义的。</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_COMMENT_SEMICOLON<span class="token punctuation">;</span>
          <span class="token comment">// 代办：安装 '%' 功能</span>
          <span class="token comment">// } else if (c == '%') {</span>
            <span class="token comment">// 程序开始-结束百分比符号还不支持。</span>
            <span class="token comment">// 注意：这可能被安装用来告诉Grbl一个程序相对输入运行的时间</span>
            <span class="token comment">// 位置，间隔，系统自动循环开始继续执行所有事情直到下一个标记。</span>
            <span class="token comment">// 这将会帮助修复带有明确功能的恢复问题，清空规划缓冲区用来准时执行任务</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char_counter <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>LINE_BUFFER_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检查行缓冲区溢出并设置标志位。</span>
            line_flags <span class="token operator">|=</span> LINE_FLAG_OVERFLOW<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字母改成大写</span>
            line<span class="token punctuation">[</span>char_counter<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token operator">-</span><span class="token char">'a'</span><span class="token operator">+</span><span class="token char">'A'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            line<span class="token punctuation">[</span>char_counter<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
    
  <span class="token punctuation">}</span>
</code></pre></div><p>从USB串口读取数据部分的源码，为避免注意力过度分散，我们放在后面硬件部分集中分析。</p> <h2 id="开始自动周期"><a href="#开始自动周期" class="header-anchor">#</a> 开始自动周期</h2> <p>G代码经过一系列处理后会进行一系列的信号加工，最后生成待执行的队列，默认设置了自动开启循环，会依次执行队列中的数据，并更新队列，这部分我们等到后面信号处理的时候在说，这也是一个初次看GRBL源码容易被忽略的地方导致分析断层。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 如果在串口读缓冲区没有字符需要处理或执行，这会通知g代码流已填充到规划器缓冲区或已完成。</span>
<span class="token comment">// 不管哪种情况，如果开启了自动循环，就会开始自动循环，队列就会移动。</span>
<span class="token function">protocol_auto_cycle_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="终止信号"><a href="#终止信号" class="header-anchor">#</a> 终止信号</h2> <p>如果碰到sys.abort信号就会退出主循环到main的循环中去重置系统（GRBL的状态机）。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 如果系统终止，返回到main()程序循环去重置系统。</span>
</code></pre></div><h2 id="运行时检查"><a href="#运行时检查" class="header-anchor">#</a> 运行时检查</h2> <p>由于GRBL没有实时操作系统，为了保证系统能够及时响应一些危险事件，在每一个可能会阻塞或长时间运行的地方，都安插了运行时命令检查点：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">protocol_execute_realtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 运行时命令检查点。</span>
</code></pre></div><p>这部分内容比较多我们单独章节分析。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/analysis/main.html" class="prev">
        入口
      </a></span> <span class="next"><a href="/analysis/serial.html">
        串口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0e50ef70.js" defer></script><script src="/assets/js/2.2179b996.js" defer></script><script src="/assets/js/23.03027e3a.js" defer></script>
  </body>
</html>
